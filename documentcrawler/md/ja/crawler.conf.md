# データ・クローラーの構成

`crawler` を実行するには、オプションを指定した構成ファイルが必要です。構成のサンプルが `crawler` のインストール・ディレクトリーの
`share` ディレクトリーに用意されています。それらのサンプルをコピーして変更してください。*サンプル自体は変更しないでください。*

`crawler.conf` ファイルにはクローラーに渡す情報を指定します。この情報には、クロールで使用するファイル (入力アダプター)、
クロール完了後にクロール済みファイルのコレクションを送信する宛先 (出力アダプター)、その他のクロール管理オプションが含まれます。

**注**: すべてのファイル・パスは、特に説明がない限り `config` ディレクトリーを基準にした相対パスです。

このファイルで設定できるオプションは、以下のとおりです。

## 入力アダプター
*  **class** - 内部使用のみ。Data Crawler の入力アダプター・クラスを定義します。デフォルト値は `com.ibm.watson.crawler.connectorframeworkinputadapter.Crawl` です。
*  **config** - 内部使用のみ。コネクター・フレームワーク構成を定義します。選択した入力アダプターに渡すこのブロック内のデフォルトの構成キーは `connector_framework` です。**注** - コネクター・フレームワークとは、データにアクセスするための機能です。これは、企業の内部データであることもあれば、Web 上やクラウド内の外部データであることもあります。コネクターにより複数の異なるデータ・ソースへのアクセスが可能になりますが、接続を実際に制御するのはクロール・プロセスです。
  -  **重要** - コネクター・フレームワークの入力アダプターで取得するデータは、ローカルのキャッシュに入れられます。暗号化された状態で保管されるわけではありません。デフォルトの場合、データは一時ディレクトリーにキャッシュされます。そのディレクトリーは、リブート時にクリアするように設定しておく必要があり、クローラー・コマンドを実行したユーザーだけが読み取れるように設定しておくべきです。コネクター・フレームワークがクリーンアップの前に終了してしまうと、クローラーの終了後にそのディレクトリーが存在し続ける可能性があります。データをキャッシュする場所を慎重に検討してください。暗号化されたファイル・システムに置くこともできますが、その場合はパフォーマンスへの影響に注意しなければなりません。クロールのスピードとセキュリティーのバランスをよく考えて決める必要があります。
*  **crawl_config_file** - クロールに使用する構成ファイル。デフォルト値は `connectors/filesystem.conf` です。
*  **crawl_seed_file** - クロールに使用するクロール・シード・ファイル。デフォルト値は `seeds/filesystem-seed.conf` です。
*  **id_vcrypt_file** - クローラーでデータ暗号化に使用される鍵ファイル。クローラーに組み込まれているデフォルト鍵は `id_vcrypt` です。
新規 id_vcrypt_file を生成する必要がある場合は、`bin` フォルダー内の vcrypt スクリプトを使用します。
*  **crawler_temp_dir** - コネクター・ログ用の Crawler の一時フォルダー。デフォルト値 `tmp` が指定されています。このフォルダーがまだ存在しない場合は、現行作業ディレクトリーに `tmp` フォルダーが作成されます。
*  **extra_jars_dir** - 内部使用のみ。コネクター・フレームワーク・クラスパスにさらに JAR を追加します。
SharePoint コネクターを使用する場合は `oakland`、データベース・コネクターを使用する場合は `database` という値にしてください。その他のコネクターを使用する場合は、空の値 (空のストリング "") のままでかまいません。
  **注**: コネクター・フレームワークの `lib/java` ディレクトリーを基準にした相対パスです。
*  **urls_to_filter** - クロールする URL のホワイトリスト (正規表現形式)。改行で区切って指定します。Data Crawler では、指定した正規表現のいずれかに一致する URL のみがクロールされます。ドメイン・リストには、最も一般的な最上位ドメインが含まれているので、必要に応じてこれを追加します。ファイル拡張子タイプのリストには、Data Crawler のリリース時点でオーケストレーション・サービスがサポートしているファイル拡張子が含まれています。ご使用のシード URL のドメインがこのフィルターで許可されていることを確認してください。例えば、`http://testdomain.test.in` のようなシード URL の場合は、ドメイン・フィルターに「`in`」を追加します。Crawler がハングする場合があるため、シード URL がフィルターで除外されないようにしてください。
*  **max_text_size** - 文書に許容される最大サイズ (バイト)。これを超えると、コネクター・フレームワークによってディスクに文書が書き込まれます。この値を調整して増やすと、ディスクに書き込まれる文書の量が少なくなりますが、メモリー所要量は増えます。
*  **extra_vm_params** - コネクター・フレームワークを起動するために使用するコマンドにさらに Java パラメーターを追加できます。
*  **bootstrap_logging** - コネクター・フレームワークの開始ログを書き込みます。拡張デバッグの場合にのみ便利です。値は `true` と `false` のいずれかです。ログ・ファイルは `crawler_temp_dir` に書き込まれます。

## ストレージ・アダプター

クローラーの内部状態をデータベースに格納します。クロールの `restart` オプションと `resume` オプションを正しく実行するために、この設定が必要です。

```javascript
storage_adapter {
 config = "storage_in_db"
  storage_in_db {
    include "storage/database_storage.conf"
  } 
}
```
参照先のファイル `storage/database_storage.conf` は、デフォルトで H2 データベースを使用します。JDBC ドライバーを使用すれば、デフォルトのデータベースの代わりにどんなデータベースでも利用できます。設定に関する具体的な情報については、JDBC ドライバーの資料を参照してください。デフォルト・オプションを直接変更する場合は、`config/storage/database_storage.conf` ファイルを開いて、それぞれのユース・ケースに合わせて以下の値を変更します。

*  **class** - このクラスは使用するデータベース・アダプター・クラスを参照します。デフォルト値は `com.ibm.watson.crawler.storageadapters.DatabasePersistAdapter` です。
*  **driver** - JDBC ドライバーのクラス。デフォルト値は `org.h2.Driver` です (H2 を使用します)。
*  **url** - ドライバーの JDBC オプションを参照します。これは JDBC 接続ストリングの URL 接頭部です。デフォルトは `jdbc:h2:file:` です。
*  **database_location** - データベースの場所。sqlite や H2 などのファイル・ベースのデータベースだけが対象になります。デフォルト値は `./storage/database` です。
*  **database_name** - データベースの名前。デフォルト値は `ActivityDB` です。
*  **table_name** - 使用するテーブルの名前。デフォルト値は `Ledger` です。
*  **username** - データベースに接続するユーザー名。
*  **password** - データベースに接続するパスワード。

ほとんどのアクティビティーではデフォルトの構成で十分です。

## 出力アダプター

いくつかの*出力アダプター*の中から選択できます。`crawler.conf` の `output_adapter.class` で
出力アダプターを設定してください。オプションは以下のとおりです。

*  **class** - Data Crawler の出力アダプター・クラスを定義します。デフォルト値は `com.ibm.watson.crawler.discoveryserviceoutputadapter.DiscoveryServiceOutputAdapter` です。
*  **config** - 出力アダプターに渡す構成キーを定義します。この構成オブジェクト内のキーに対応するストリングを指定してください。以下に、コード例を示します。

```javascript
  orchestration_service {
    include "orchestration_service.conf"
          },
          test {
             output_directory = "/tmp/crawler-test-output"
          }
         }
```
構成キーは `orchestration_service` です。デフォルト値は `discovery_service` です。

出力アダプターを選択するには、`class` パラメーターと `config` キーを指定しなければなりません。

* **オーケストレーション・サービス出力アダプター**: クロール済みの文書を Watson Developer Cloud のオーケストレーション・サービスにアップロードします。このアダプターを選択する場合は、`class` パラメーターと `config` キーを以下のように設定します。 
```javascript
  class = "com.ibm.watson.crawler.orchestrationserviceoutputadapter.oneatatime.OrchestrationServiceOutputAdapter"
  config = "orchestration_service"
  orchestration_service {
    include "orchestration/orchestration_service.conf"
  }
```
* **ディスカバリー・サービス出力アダプター**: クロール済みの文書を Watson Developer Cloud のディスカバリー・サービスにアップロードします。このアダプターを選択する場合は、`class` パラメーターと `config` キーを以下のように設定します。
```javascript
  class = "com.ibm.watson.crawler.discoveryserviceoutputadapter.DiscoveryServiceOutputAdapter"
  config = "discovery_service"
  discovery_service {
    include "discovery/discovery_service.conf"
  }
```
* **Watson テスト出力アダプター**: クロール済みのファイルを表現した項目をディスク内の指定の場所に書き込みます。このアダプターを選択する場合は、`class` パラメーターと `config` キーを以下のように設定します。

**注** - 追加のパラメーター `output_directory` を使用して、クロール済みのデータを表現した項目を書き込むディレクトリーを選択できます。
```javascript
  class = "com.ibm.watson.crawler.testoutputadapter.TestOutputAdapter"
  config = "test"
  output_directory = "/tmp/crawler-test-output"
```
* **retry** - 出力アダプターにプッシュする処理が失敗した場合の再試行のオプションを指定します。
  * max_attempts - 再試行の最大数。デフォルト値は `10` です。
  * delay - 再試行と再試行の間の最小遅延時間 (秒)。デフォルト値は `2` です。
  * exponent_base - 試行失敗のたびに遅延時間を長く設定するための係数。デフォルト値は `2` です。

 数式は以下のとおりです。
```
 d(nth_retry) = delay * (exponent_base ^ nth_retry)
```

 例えば、delay を 1 秒、exponent base を 2 に設定すると、2 回目の再試行と 3 回目の再試行の間の
遅延時間は 1 秒ではなく 2 秒になり、その次の遅延時間は 4 秒になります。
 ```
 d(0) = 1 * (2 ^ 0) = 1 秒
 d(1) = 1 * (2 ^ 1) = 2 秒
 d(2) = 1 * (2 ^ 2) = 4 秒
```
デフォルト設定の場合、実行依頼の最大試行回数は 10 回になり、約 1,022 秒 (17 分と少し) の待ち時間が生じます。この時間が概数になるのは、複数の再実行依頼の同時実行を避けるために余分の時間が追加されるからです。その追加の時間は最大で 10% なので、前の例の最後の再試行の遅延時間は最大で 4.4 秒になります。この待ち時間には、サービスへの接続やデータのアップロードにかかる時間や応答待ちの時間は含まれていません。

 *警告:* デフォルト値よりも小さい値を設定して待ち時間を短くすると、構成済みの出力アダプターを使用すると文書が
正常にアップロードされなくなる危険があります。Watson Developer Cloud サービスを使用している場合、
そのような状況になると、速度制限に関する「429 Too Many Requests」という RetryFailure メッセージがログに書き込まれます。
 
## デバッグ・オプション
*  **full_node_debugging** - デバッグ・モードをアクティブにします。可能な値は `true` または `false` です。**警告**: この設定の場合、クロール済みのすべての文書の全データがログに書き込まれます。
*  **heartbeat_wait_time** - 文書取り込み統計のレポート間隔の時間 (ミリ秒) (デバッグ・モードのみ)。デフォルト値は 1000 ミリ秒です。

## ロギング・オプション
*  **configuration_file** - ロギングに使用する構成ファイル。サンプルの `crawler.conf` ファイルでは、このオプションは `logging.log4j` 内に定義され、そのデフォルト値は `log4j_custom.properties` です。
このオプションは、`.properties` ファイルまたは `.conf` ファイルのいずれを使用するかに関わらず、同様に定義する必要があります。

## 追加のクロール管理オプション
*  **shutdown_timeout** - アプリケーションがシャットダウンされるまでのタイムアウト値 (分) を指定します。デフォルト値は `10` です。
*  **output_limit** - Crawler で出力アダプターへの同時送信が試行されるインデックス付け可能な項目の最大数。これは、処理に使用できるコア数によってさらに制限される場合があります。これは、いずれの時点でも、出力アダプターに送信され、返されるまで待機しているインデックス付け可能な項目が「x」個以下であることを示します。デフォルト値は `10` です。
*  **input_limit** - コネクターから一度に要求できる URL の数を制限します。デフォルト値は `3` です。
*  **output_timeout** - Data Crawler が出力アダプターへの要求を中止し、後続の処理のために出力アダプター・キューから項目を削除するまでの時間の長さ (秒) です。デフォルト値は `1200` です。**注** - 出力アダプターによる制約を考慮してください。その制約は、ここで定義する制限値に関係する場合があるからです。前述の定義された `output_limit` は、出力アダプターに一度に送信できるインデックス付け可能なオブジェクト数にのみ関係があります。インデックス付け可能なオブジェクトが出力アダプターに送信されると、`output_timeout` 変数で定義されている「クロックによるカウント」が開始されます。
出力アダプター自体にスロットルがあり、受け取った数と同数の入力が処理されないようになっている場合があります。例えば、オーケストレーション出力アダプターには、サービスへの HTTP 接続用に構成できる接続プールがある場合があります。例えば、これがデフォルトで 8 に設定されている場合に `output_limit` を 8 より大きい数値に設定すると、実行の順番を待機中で、クロックによるカウントが開始されるプロセスが出てきます。その後、タイムアウトになる場合があります。
*  **num_threads** - 一度に実行できる並行スレッドの数。この値は、整数 (並行スレッドの数を直接指定)、またはストリング ("xNUM" というフォーマットで、使用可能なプロセッサー数の倍数を指定) のいずれかになります ("x1.5" など)。デフォルト値は `"30"` です。

## 関連資料

crawler(1)

vcrypt(1)

crawler-options.conf(5)

crawler-seed.conf(5)

orchestration_service.conf(5)
